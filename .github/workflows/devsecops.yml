name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # 1) Checkout
      # =========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # 2) Setup Node + Python (Semgrep)
      # =========================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # =========================
      # 3) Create env files (NO secrets)
      # =========================
      - name: Create env files for Docker Compose
        shell: bash
        run: |
          set -euo pipefail

          cp backend/users-service/.env.example backend/users-service/.env
          cp backend/academic-service/.env.example backend/academic-service/.env
          cp backend/api-gateway/.env.example backend/api-gateway/.env
          cp frontend/.env.example frontend/.env

          # Gateway -> internal compose DNS
          echo "USERS_SERVICE_URL=http://users-service:3001" >> backend/api-gateway/.env
          echo "ACADEMIC_SERVICE_URL=http://academic-service:3002" >> backend/api-gateway/.env

          # Frontend -> gateway
          echo "VITE_API_URL=http://api-gateway:3000" >> frontend/.env

      # =========================
      # 4) Install + Lint + Tests
      # =========================
      - name: Install & Test users-service
        shell: bash
        run: |
          set -euo pipefail
          cd backend/users-service
          npm ci
          npm test

      - name: Install & Test academic-service
        shell: bash
        run: |
          set -euo pipefail
          cd backend/academic-service
          npm ci
          npm test

      - name: Install & Test api-gateway
        shell: bash
        run: |
          set -euo pipefail
          cd backend/api-gateway
          npm ci
          npm test

      - name: Install, Lint & Test frontend
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          npm ci
          npm run lint
          npm test

      # =========================
      # 5) SAST - Semgrep (CLI)  ✅ (sin workdir)
      # =========================
      - name: Install Semgrep
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install semgrep

      - name: SAST users-service (Semgrep)
        shell: bash
        run: |
          set -euo pipefail
          cd backend/users-service
          semgrep --config=auto --severity=ERROR

      - name: SAST academic-service (Semgrep)
        shell: bash
        run: |
          set -euo pipefail
          cd backend/academic-service
          semgrep --config=auto --severity=ERROR

      - name: SAST api-gateway (Semgrep)
        shell: bash
        run: |
          set -euo pipefail
          cd backend/api-gateway
          semgrep --config=auto --severity=ERROR

      - name: SAST frontend (Semgrep)
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          semgrep --config=auto --severity=ERROR

      # =========================
      # 6) SCA - npm audit (gate HIGH/CRITICAL)
      # =========================
      - name: SCA users-service (npm audit)
        shell: bash
        run: |
          set -euo pipefail
          cd backend/users-service
          
          npm audit --audit-level=high --omit=dev

      - name: SCA academic-service (npm audit)
        shell: bash
        run: |
          set -euo pipefail
          cd backend/academic-service
          npm audit --audit-level=high --omit=dev

      - name: SCA api-gateway (npm audit)
        shell: bash
        run: |
          set -euo pipefail
          cd backend/api-gateway
          npm audit --audit-level=high --omit=dev

      - name: SCA frontend (npm audit)
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          npm audit --audit-level=high --omit=dev

      # =========================
      # 7) Build Docker images (Compose)
      # =========================
      - name: Build Docker images (docker compose)
        shell: bash
        run: |
          set -euo pipefail
          cd backend
          docker compose build

      # (Opcional) Tag con SHA si tus imágenes existen con esos nombres.
      # Si tu compose define "image: users-service", esto funcionará.
      - name: Tag images with commit SHA (versioning)
        shell: bash
        run: |
          set -euo pipefail
          SHA="${{ github.sha }}"
          docker tag users-service users-service:${SHA}
          docker tag academic-service academic-service:${SHA}
          docker tag api-gateway api-gateway:${SHA}

      # =========================
      # 8) Container Scan - Trivy (gate HIGH/CRITICAL)
      # =========================
      - name: Trivy scan users-service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "users-service:${{ github.sha }}"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      - name: Trivy scan academic-service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "academic-service:${{ github.sha }}"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      - name: Trivy scan api-gateway
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "api-gateway:${{ github.sha }}"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      # =========================
      # 9) Run stack + Smoke tests
      # =========================
      - name: Start containers (docker compose up)
        shell: bash
        run: |
          set -euo pipefail
          cd backend
          docker compose up -d

      - name: Smoke test (health + auth + protected endpoint)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

          # Health
          curl -fsS http://localhost:3000/health

          # Login (gateway)
          TOKEN=$(curl -fsS -X POST http://localhost:3000/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@test.cl","password":"123456"}' | jq -r '.token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "ERROR: token not received from login"
            exit 1
          fi

          # Protected resource
          curl -fsS http://localhost:3000/courses \
            -H "Authorization: Bearer $TOKEN"

      - name: Cleanup (docker compose down)
        if: always()
        shell: bash
        run: |
          cd backend
          docker compose down --volumes