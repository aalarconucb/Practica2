name: DevSecOps CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------
      # Prepare env files (NO secrets)
      # ----------------------------
      - name: Create env files for Docker Compose
        shell: bash
        run: |
          set -euo pipefail

          cp backend/users-service/.env.example backend/users-service/.env
          cp backend/academic-service/.env.example backend/academic-service/.env
          cp backend/api-gateway/.env.example backend/api-gateway/.env
          cp frontend/.env.example frontend/.env

          # Point gateway to internal docker-compose service names
          echo "USERS_SERVICE_URL=http://users-service:3001" >> backend/api-gateway/.env
          echo "ACADEMIC_SERVICE_URL=http://academic-service:3002" >> backend/api-gateway/.env

          # Frontend should call gateway (compose service name)
          echo "VITE_API_URL=http://api-gateway:3000" >> frontend/.env

      # ----------------------------
      # Install (reproducible), Quality, Tests
      # ----------------------------
      - name: Install & Test users-service
        shell: bash
        run: |
          set -euo pipefail
          cd backend/users-service
          npm ci
          npm test

      - name: Install & Test academic-service
        shell: bash
        run: |
          set -euo pipefail
          cd backend/academic-service
          npm ci
          npm test

      - name: Install & Test api-gateway
        shell: bash
        run: |
          set -euo pipefail
          cd backend/api-gateway
          npm ci
          npm test

      - name: Install, Lint & Test frontend
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          npm ci
          npm run lint
          npm test

      # ----------------------------
      # SAST (Semgrep) - Backend + Frontend
      # ----------------------------
      - name: SAST users-service (Semgrep)
        uses: semgrep/semgrep-action@v1
        with:
          workdir: backend/users-service
          config: auto
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: SAST academic-service (Semgrep)
        uses: semgrep/semgrep-action@v1
        with:
          workdir: backend/academic-service
          config: auto
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: SAST api-gateway (Semgrep)
        uses: semgrep/semgrep-action@v1
        with:
          workdir: backend/api-gateway
          config: auto
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: SAST frontend (Semgrep)
        uses: semgrep/semgrep-action@v1
        with:
          workdir: frontend
          config: auto
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      # ----------------------------
      # SCA (Dependencies) - npm audit as a gate
      # ----------------------------
      - name: SCA users-service (npm audit)
        shell: bash
        run: |
          set -euo pipefail
          cd backend/users-service
          npm audit --audit-level=high

      - name: SCA academic-service (npm audit)
        shell: bash
        run: |
          set -euo pipefail
          cd backend/academic-service
          npm audit --audit-level=high

      - name: SCA api-gateway (npm audit)
        shell: bash
        run: |
          set -euo pipefail
          cd backend/api-gateway
          npm audit --audit-level=high

      - name: SCA frontend (npm audit)
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          npm audit --audit-level=high

      # ----------------------------
      # Build containers + version tag (SHA)
      # ----------------------------
      - name: Build Docker images (docker compose)
        shell: bash
        run: |
          set -euo pipefail
          cd backend
          docker compose build

      - name: Tag images with commit SHA (artifact versioning)
        shell: bash
        run: |
          set -euo pipefail
          SHA="${{ github.sha }}"
          docker tag users-service users-service:${SHA}
          docker tag academic-service academic-service:${SHA}
          docker tag api-gateway api-gateway:${SHA}

      # ----------------------------
      # Container image security scan (Trivy) - HIGH/CRITICAL gate
      # ----------------------------
      - name: Trivy scan users-service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "users-service:${{ github.sha }}"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      - name: Trivy scan academic-service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "academic-service:${{ github.sha }}"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      - name: Trivy scan api-gateway
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "api-gateway:${{ github.sha }}"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      # ----------------------------
      # Run stack + Smoke tests (health + login + protected endpoint)
      # ----------------------------
      - name: Start containers (docker compose up)
        shell: bash
        run: |
          set -euo pipefail
          cd backend
          docker compose up -d

      - name: Smoke test (health + auth + protected resource)
        shell: bash
        run: |
          set -euo pipefail

          sudo apt-get update -y
          sudo apt-get install -y jq

          # Health
          curl -fsS http://localhost:3000/health | tee /tmp/health.json

          # Login (via gateway)
          TOKEN=$(curl -fsS -X POST http://localhost:3000/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@test.cl","password":"123456"}' | jq -r '.token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "ERROR: token not received from login"
            exit 1
          fi

          # Protected endpoint (via gateway)
          curl -fsS http://localhost:3000/courses \
            -H "Authorization: Bearer $TOKEN" | tee /tmp/courses.json

      - name: Cleanup (docker compose down)
        if: always()
        shell: bash
        run: |
          cd backend
          docker compose down --volumes